<!DOCTYPE html>
<!-- saved from url=(0103)file:///Users/cdavis21/Desktop/Personal/AISC/Applied%20Assumption%20Tree%20%E2%80%94%20Davis%202.2.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Applied Assumption Tree — AISC Team 19</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
    background: #0F172A;
    color: #E2E8F0;
    line-height: 1.45;
    min-height: 100vh;
    padding: 24px;
  }

  .canvas {
    max-width: 1440px;
    margin: 0 auto;
  }

  /* ===== HEADER ===== */
  .header {
    text-align: center;
    margin-bottom: 20px;
  }
  .header h1 {
    font-size: clamp(26px, 3.5vw, 34px);
    font-weight: 800;
    letter-spacing: -0.5px;
    color: white;
    margin-bottom: 6px;
  }
  .header .sub {
    font-size: 13px;
    color: #94A3B8;
    font-weight: 500;
  }

  /* ===== INTERACTIVE ELEMENTS ===== */
  .interactive {
    position: relative;
    cursor: grab;
    transition: box-shadow 0.15s, transform 0.15s;
  }
  .interactive:active { cursor: grabbing; }
  .interactive.dragging { z-index: 500; opacity: 0.92; }
  .interactive:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.3); }

  /* Universal delete button */
  .interactive > .delete-btn {
    position: absolute;
    top: -8px;
    right: -8px;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: #EF4444;
    color: white;
    border: 2px solid #0F172A;
    font-size: 13px;
    line-height: 18px;
    text-align: center;
    cursor: pointer;
    display: none;
    z-index: 10;
  }
  .interactive:hover > .delete-btn { display: block; }
  .interactive.editing > .delete-btn { display: none; }

  /* Universal editing outline */
  .interactive.editing {
    outline: 2px solid #3B82F6;
    outline-offset: 2px;
    cursor: text;
  }
  [contenteditable]:focus { outline: none; }

  /* ===== ROOT NODE ===== */
  .root-banner {
    background: linear-gradient(135deg, #1E293B 0%, #334155 100%);
    border: 1px solid #475569;
    border-radius: 12px;
    padding: 18px 32px;
    text-align: center;
    max-width: 520px;
    margin: 0 auto 14px;
  }
  .root-banner h2 {
    font-size: 20px;
    font-weight: 800;
    color: white;
    margin-bottom: 4px;
  }
  .root-banner .gate {
    display: inline-block;
    background: #F59E0B;
    color: #0F172A;
    font-size: 11px;
    font-weight: 800;
    padding: 3px 12px;
    border-radius: 10px;
    letter-spacing: 0.8px;
  }

  /* ===== CONNECTOR ===== */
  .connector {
    display: flex;
    justify-content: center;
    margin-bottom: 12px;
    position: relative;
  }
  .connector::before {
    content: '';
    position: absolute;
    top: 0;
    width: 2px;
    height: 14px;
    background: #475569;
  }

  /* ===== BRANCH COLUMNS ===== */
  .branches {
    display: grid;
    grid-template-columns: repeat(3, minmax(280px, 1fr));
    gap: 18px;
    max-width: 1400px;
    margin: 0 auto;
  }

  .branch {
    border-radius: 14px;
    padding: 0;
    overflow: visible;
  }

  /* Branch header (L1) */
  .branch-header {
    padding: 14px 18px;
    text-align: center;
    border-radius: 14px 14px 0 0;
  }
  .branch-header h3 {
    font-size: 16px;
    font-weight: 800;
    color: white;
    margin-bottom: 2px;
  }
  .branch-header .gate {
    display: inline-block;
    font-size: 10px;
    font-weight: 700;
    padding: 3px 10px;
    border-radius: 8px;
    letter-spacing: 0.6px;
    text-transform: uppercase;
    margin-top: 4px;
  }
  .branch-blue .branch-header .gate { background: #1E3A5F; color: #60A5FA; }
  .branch-green .branch-header .gate { background: #14532D; color: #4ADE80; }
  .branch-gold .branch-header .gate { background: #713F12; color: #FDE047; }
  .branch-header .branch-num {
    font-size: 11px;
    font-weight: 600;
    opacity: 0.6;
    margin-bottom: 4px;
  }
  .branch-header .formalism {
    font-size: 12px;
    font-weight: 400;
    font-style: italic;
    color: #94A3B8;
    opacity: 0.85;
    margin-top: 5px;
    line-height: 1.4;
  }
  .branch-header .formalism span {
    font-size: inherit !important;
  }
  .branch-header .substitution-note {
    margin-top: 4px;
    padding: 4px 10px;
    background: rgba(59, 130, 246, 0.12);
    border: 1px solid rgba(59, 130, 246, 0.25);
    border-radius: 6px;
    font-style: normal;
    font-weight: 500;
    font-size: 11px;
    color: #93C5FD;
  }

  /* Branch body */
  .branch-body {
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    border-radius: 0 0 14px 14px;
  }

  /* Branch colors */
  .branch-blue .branch-header { background: linear-gradient(135deg, #1E3A5F 0%, #1B4F72 100%); }
  .branch-blue .branch-body { background: #0F2438; }
  .branch-blue .card { border-left-color: #3B82F6; }
  .branch-blue .card .card-gate { background: #1E3A5F; color: #60A5FA; }
  .branch-blue .l3-dot { background: #3B82F6; }

  .branch-green .branch-header { background: linear-gradient(135deg, #14532D 0%, #166534 100%); }
  .branch-green .branch-body { background: #0A1F12; }
  .branch-green .card { border-left-color: #22C55E; }
  .branch-green .card .card-gate { background: #14532D; color: #4ADE80; }
  .branch-green .l3-dot { background: #22C55E; }

  .branch-gold .branch-header { background: linear-gradient(135deg, #713F12 0%, #854D0E 100%); }
  .branch-gold .branch-body { background: #1A1207; }
  .branch-gold .card { border-left-color: #EAB308; }
  .branch-gold .card .card-gate { background: #713F12; color: #FDE047; }
  .branch-gold .l3-dot { background: #EAB308; }

  /* ===== L2 CARDS ===== */
  .card {
    background: #1E293B;
    border-radius: 10px;
    border-left: 4px solid;
    padding: 14px;
  }

  .card-top {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 5px;
  }
  .card h4 {
    font-size: 14px;
    font-weight: 700;
    color: #F1F5F9;
    flex: 1;
  }
  .card .card-gate {
    font-size: 10px;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 8px;
    letter-spacing: 0.5px;
    flex-shrink: 0;
  }

  /* I-label accent for Branch 1 cards */
  .i-label {
    display: inline-block;
    font-size: 11px;
    font-weight: 700;
    color: #60A5FA;
    background: #1E3A5F;
    padding: 1px 8px;
    border-radius: 6px;
    margin-left: 4px;
    letter-spacing: 0.3px;
    vertical-align: baseline;
  }
  .card .card-formalism {
    font-size: 12px;
    font-style: italic;
    color: #8B9BB4;
    margin-bottom: 8px;
    line-height: 1.4;
  }
  .card .card-formalism font {
    font-size: inherit !important;
  }

  /* L3 items inside cards */
  .l3-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .l3-item {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    font-size: 13px;
    color: #94A3B8;
    font-weight: 500;
    line-height: 1.4;
  }
  .l3-dot {
    width: 5px;
    height: 5px;
    border-radius: 50%;
    flex-shrink: 0;
    margin-top: 6px;
  }
  /* Hide empty L3 items (stale editing artifacts) */
  .l3-item:has(.l3-text:empty),
  .l3-item:has(.l3-text > br:only-child) {
    display: none;
  }

  /* ===== RISK AMPLIFIERS ===== */
  .amplifiers {
    max-width: 700px;
    margin: 20px auto 0;
    background: linear-gradient(135deg, #451A03 0%, #78350F 100%);
    border: 1px dashed #D97706;
    border-radius: 12px;
    padding: 14px 22px;
    text-align: center;
  }
  .amplifiers h4 {
    font-size: 13px;
    font-weight: 700;
    color: #FDE047;
    margin-bottom: 4px;
  }
  .amplifiers .amp-formalism {
    font-size: 12px;
    font-style: italic;
    color: #D97706;
    opacity: 0.85;
    margin-bottom: 6px;
  }
  .amplifiers p {
    font-size: 12px;
    color: #D97706;
    line-height: 1.5;
  }

  /* ===== FORMULA BAR ===== */
  .formula-bar {
    max-width: 1400px;
    margin: 20px auto 0;
    display: flex;
    justify-content: center;
    gap: 24px;
    flex-wrap: wrap;
    padding: 12px 20px;
    background: #1E293B;
    border-radius: 10px;
    font-size: 13px;
    color: #8B9BB4;
  }
  .formula-bar span { font-weight: 700; }
  .fb-blue { color: #60A5FA; }
  .fb-green { color: #4ADE80; }
  .fb-gold { color: #FDE047; }
  .fb-white { color: #F1F5F9; }

  /* ===== LEGEND ===== */
  .legend {
    max-width: 1400px;
    margin: 14px auto 0;
    display: flex;
    justify-content: center;
    gap: 20px;
    font-size: 12px;
    color: #64748B;
    padding: 8px 16px;
    border-radius: 8px;
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .legend-and {
    background: #F59E0B;
    color: #0F172A;
    font-size: 9px;
    font-weight: 800;
    padding: 2px 7px;
    border-radius: 6px;
  }
  .legend-or {
    background: #475569;
    color: white;
    font-size: 9px;
    font-weight: 800;
    padding: 2px 7px;
    border-radius: 6px;
  }

  /* ===== TOOLBAR ===== */
  .toolbar {
    max-width: 1400px;
    margin: 16px auto 0;
    display: flex;
    justify-content: center;
    gap: 10px;
  }
  .toolbar button {
    padding: 6px 16px;
    border: 1px solid #334155;
    border-radius: 6px;
    background: #1E293B;
    color: #94A3B8;
    cursor: pointer;
    font-size: 11px;
    font-family: inherit;
    font-weight: 500;
    transition: background 0.15s;
  }
  .toolbar button:hover { background: #334155; color: white; }

  @media (max-width: 1180px) {
    .branches {
      grid-template-columns: repeat(2, minmax(280px, 1fr));
    }
  }

  @media (max-width: 840px) {
    body { padding: 16px; }
    .branches {
      grid-template-columns: 1fr;
    }
    .legend {
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
  }
</style>
</head>
<body>
<main class="canvas">

<!-- HEADER -->
<div class="header">
  <h1>Applied Assumption Tree</h1>
</div>

<!-- ROOT -->
<div class="root-banner interactive" id="el-root">
  <h2>AI Leads to Catastrophic Harm<div>P(DAI) = &gt;0</div></h2>
  <span class="gate">AND — ALL 3 BRANCHES MUST HOLD</span>
<div class="delete-btn" title="Hide this element">×</div></div>

<div class="connector"></div>

<!-- THREE BRANCHES -->
<div class="branches">

  <!-- ===== BRANCH 1: BLUE ===== -->
  <div class="branch branch-blue">
    <div class="branch-header interactive" id="el-b1-header">
      <div class="branch-num" contenteditable="false"></div>
      <h3 contenteditable="false">Optimization</h3>
      <div class="gate" contenteditable="false">AND — all 4 conditions are required</div>
      <div class="formalism" contenteditable="false">The 4 I's determine the level of O, applies to individual AI systems or aggregate AI ecosystem</div>
      <div class="formalism substitution-note" contenteditable="false">Each I must be &gt; 0, but they substitute at the margins — e.g., lower Intelligence with broad Influence can reach the same O.</div>
    <div class="delete-btn" title="Hide this element">×</div></div>
    <div class="branch-body">

      <div class="card interactive" id="el-card-1">
        <div class="card-top">
          <h4 contenteditable="false">Cognitive Capability <span class="i-label">Intelligence</span></h4>
          <span class="card-gate" style="display:none;" contenteditable="false"></span>
        </div>
        <div class="card-formalism" contenteditable="false">Higher intelligence increases O</div>
        <div class="l3-list">
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">AI matches or exceeds human performance in a decisive domain</span></div>
        </div>
      <div class="delete-btn" title="Hide this element">×</div></div>

      <div class="card interactive" id="el-card-2">
        <div class="card-top">
          <h4 contenteditable="false">Optimization Direction&nbsp;<span class="i-label">Interests</span></h4>
          <span class="card-gate" contenteditable="false">OR</span>
        </div>
        <div class="card-formalism" contenteditable="false">Autonomous goal seeking behavior not required</div>
        <div class="l3-list">
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">AI actions exhibit stable patterns consistent with optimizing for identifiable outcomes</span></div>
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">High impact capability under human direction even without stable autonomous goals</span></div>
        </div>
      <div class="delete-btn" title="Hide this element">×</div></div>

      <div class="card interactive" id="el-card-3" style="transform: translate(0px, 0px);">
        <div class="card-top">
          <h4 contenteditable="false">Real-World Reach <span class="i-label">Influence</span></h4>
          <span class="card-gate" contenteditable="false">OR</span>
        </div>
        <div class="card-formalism" contenteditable="false">Influence pathways convert O into real-world impact</div>
        <div class="l3-list">
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">Digital system access</span></div>
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">Robotic / physical actuators</span></div>
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">Human manipulation</span></div>
        </div>
      <div class="delete-btn" title="Hide this element">×</div></div>

      <div class="card interactive editing" id="el-card-4">
        <div class="card-top">
          <h4 contenteditable="true">Resource Access&nbsp;<span class="i-label">Inputs</span></h4>
          <span class="card-gate" contenteditable="true">OR</span>
        </div>
        <div class="card-formalism" contenteditable="true">Resource access can increase O</div>
        <div class="l3-list">
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="true">Compute / energy access</span></div>
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="true">Financial resources</span></div>
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="true"></span></div>
        </div>
      <div class="delete-btn" title="Hide this element">×</div></div>

    </div>
  </div>

  <!-- ===== BRANCH 2: GREEN ===== -->
  <div class="branch branch-green">
    <div class="branch-header interactive" id="el-b2-header">
      <div class="branch-num"></div>
      <h3>Misalignment with Human Values</h3>
      <div class="gate">OR — any pathway sufficient</div>
      <div class="formalism">O directed away from "human flourishing", helps determine p_O(o)</div>
    <div class="delete-btn" title="Hide this element">×</div></div>
    <div class="branch-body">

      <div class="card interactive" id="el-card-5" style="transform: translate(0px, 0px);">
        <div class="card-top">
          <h4 contenteditable="false">Autonomous Misalignment (AI Takeover)</h4>
          <span class="card-gate" contenteditable="false">OR</span>
        </div>
        <div class="card-formalism" contenteditable="false">At high O, the system's objectives can diverge, raising p_O(o)</div>
        <div class="l3-list">
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">There exists a difference between the optimized objective and the set of outcomes that preserve human survival, stability, or long term flourishing</span></div>
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">Instrumental convergence drives power-seeking (or similar) behavior not compatible with human flourishing</span></div>
        </div>
      <div class="delete-btn" title="Hide this element">×</div></div>

      <div class="card interactive" id="el-card-6" style="transform: translate(-1px, 0px);">
        <div class="card-top">
          <h4 contenteditable="false">Human Misuse (AI as a tool)</h4>
          <span class="card-gate" contenteditable="false">OR</span>
        </div>
        <div class="card-formalism" contenteditable="false">p_O(o) depends on who has access and how much O they can use</div>
        <div class="l3-list">
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">Intentional harmful use</span></div>
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">Unsafe deployment (negligent/accidental deployment)</span></div>
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">Other human misuse causing D</span></div>
        </div>
      <div class="delete-btn" title="Hide this element">×</div></div>

      <div class="card interactive" id="el-card-7" style="transform: translate(0px, 0px);">
        <div class="card-top">
          <h4 contenteditable="false">Structural / Emergent Dynamics&nbsp;</h4>
          <span class="card-gate" contenteditable="false">OR</span>
        </div>
        <div class="card-formalism" contenteditable="false">p_O(o) can rise gradually as system-wide O increases</div>
        <div class="l3-list">
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">Preference / Incentive drift (Universe 25)</span></div>
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">System instability (key system failure e.g. market, power grid)</span></div>
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">Critical dependence on AI systems (no human resilience)</span></div>
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">Other structural/emergent dynamics causing D</span></div>
        </div>
      <div class="delete-btn" title="Hide this element">×</div></div>

    </div>
  </div>

  <!-- ===== BRANCH 3: GOLD ===== -->
  <div class="branch branch-gold">
    <div class="branch-header interactive" id="el-b3-header">
      <div class="branch-num"></div>
      <h3>Failed Correction</h3>
      <div class="gate">OR — any failure sufficient</div>
      <div class="formalism">Environment E determines what level of O produces D</div>
    <div class="delete-btn" title="Hide this element">×</div></div>
    <div class="branch-body">

      <div class="card interactive" id="el-card-8">
        <div class="card-top">
          <h4 contenteditable="false">Detection Failure</h4>
          <span class="card-gate" contenteditable="false">OR</span>
        </div>
        <div class="card-formalism" contenteditable="false">Weak monitoring makes E more permissive, increasing p_O(o)</div>
        <div class="l3-list">
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">System behavior is opaque</span></div>
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">Active concealment</span></div>
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">Normalization / gradual harm</span></div>
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">Other detection failure</span></div>
        </div>
      <div class="delete-btn" title="Hide this element">×</div></div>

      <div class="card interactive" id="el-card-9">
        <div class="card-top">
          <h4 contenteditable="false">Willingness Failure</h4>
          <span class="card-gate" contenteditable="false">OR</span>
        </div>
        <div class="card-formalism" contenteditable="false">Known risk without action keeps E permissive, increasing p_O(o)</div>
        <div class="l3-list">
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">Economic lock-in / dependency</span></div>
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">Political / regulatory capture</span></div>
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">Optimism bias / risk tolerance</span></div>
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">Other willingness failure</span></div>
        </div>
      <div class="delete-btn" title="Hide this element">×</div></div>

      <div class="card interactive" id="el-card-10">
        <div class="card-top">
          <h4 contenteditable="false">Capability Failure</h4>
          <span class="card-gate" contenteditable="false">OR</span>
        </div>
        <div class="card-formalism" contenteditable="false">Even when misalignment is detected, E may lack capacity to reduce p_O(o)</div>
        <div class="l3-list">
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">Technical intractability</span></div>
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">Response speed mismatch</span></div>
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">Infrastructure integration lock-in</span></div>
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">Other capability failure</span></div>
        </div>
      <div class="delete-btn" title="Hide this element">×</div></div>

      <div class="card interactive" id="el-card-11" style="transform: translate(0px, 0px);">
        <div class="card-top">
          <h4 contenteditable="false">Coordination Failure</h4>
          <span class="card-gate" contenteditable="false">OR</span>
        </div>
        <div class="card-formalism" contenteditable="false">Fragmented governance weakens shared constraints in E, increasing p_O(o)</div>
        <div class="l3-list">
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">Geopolitical competition</span></div>
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">Failed or fragmented governance and regulation</span></div>
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">Multipolar dynamics</span></div>
          <div class="l3-item"><span class="l3-dot"></span><span class="l3-text" contenteditable="false">Other coordination failure</span></div>
        </div>
      <div class="delete-btn" title="Hide this element">×</div></div>

    </div>
  </div>

</div>

<!-- RISK AMPLIFIERS -->
<div class="amplifiers interactive" id="el-amplifiers">
  <h4>Risk Amplifiers</h4>
  <div class="amp-formalism">These factors shift E and can move multiple conditions at once.</div>
  <p>Incentives that reward speed over safety · Information asymmetry and secrecy between actors · Recursive self-improvement potential · Broad voluntary AI adoption · Competitive deployment pressure and race dynamics</p>
<div class="delete-btn" title="Hide this element">×</div></div>

<!-- FORMULA BAR -->
<div class="formula-bar interactive" id="el-formula" style="display: none;">
  <div><span class="fb-blue">g(o | C, I, R, E)</span> ← Branch 1</div>
  <div><span class="fb-green">p<sub>O</sub>(o | M, E)</span> ← Branch 2</div>
  <div><span class="fb-gold">E (environment)</span> ← Branch 3</div>
  <div><span class="fb-white">P(Doom) = ∫ p<sub>O</sub> · g do</span></div>
<div class="delete-btn" title="Hide this element">×</div></div>

<!-- LEGEND -->
<div class="legend interactive" id="el-legend">
  <div class="legend-item"><span class="legend-and">AND</span> All sub-conditions required</div>
  <div class="legend-item"><span class="legend-or">OR</span> Any sub-condition sufficient</div>
  <div class="legend-item">Double-click to edit · Hover × to hide</div>
<div class="delete-btn" title="Hide this element">×</div></div>

<!-- TOOLBAR -->
<div class="toolbar">
  <button onclick="resetAll()">Reset All</button>
</div>
</main>

<script>
/* Unified interactive behavior: drag, edit, hide, reset */
const defaults = {};
const state = new WeakMap();

function getTranslate(el) {
  const match = el.style.transform.match(/translate\((-?[\d.]+)px,\s*(-?[\d.]+)px\)/);
  return match ? { x: parseFloat(match[1]), y: parseFloat(match[2]) } : { x: 0, y: 0 };
}

function ensureDeleteButton(el) {
  const existing = el.querySelector(':scope > .delete-btn');
  if (existing) existing.remove();
  const delBtn = document.createElement('div');
  delBtn.className = 'delete-btn';
  delBtn.textContent = '×';
  delBtn.title = 'Hide this element';
  el.appendChild(delBtn);
}

function exitEdit(el) {
  const current = state.get(el);
  if (!current || !current.editing) return;
  current.editing = false;
  el.classList.remove('editing');
  el.querySelectorAll('[contenteditable]').forEach(node => {
    node.contentEditable = 'false';
  });
  window.getSelection().removeAllRanges();
}

function initializeInteractive(el) {
  if (!el.id) return;
  ensureDeleteButton(el);

  defaults[el.id] = {
    html: el.innerHTML,
    display: el.style.display || '',
    transform: el.style.transform || ''
  };

  state.set(el, {
    editing: false,
    dragging: false,
    startX: 0,
    startY: 0,
    originX: 0,
    originY: 0
  });

  el.addEventListener('mousedown', (e) => {
    const current = state.get(el);
    if (!current || current.editing) return;
    if (e.target.closest('.delete-btn')) return;

    current.dragging = true;
    current.startX = e.clientX;
    current.startY = e.clientY;
    const t = getTranslate(el);
    current.originX = t.x;
    current.originY = t.y;
    el.classList.add('dragging');
    e.preventDefault();
  });

  el.addEventListener('dblclick', (e) => {
    const current = state.get(el);
    if (!current || current.editing) return;

    current.editing = true;
    el.classList.add('editing');

    const editables = el.querySelectorAll(
      'h2, h3, h4, .gate, .formalism, .branch-num, .l3-text, ' +
      '.card-gate, .card-formalism, .amp-formalism, p, .legend-item, ' +
      '.fb-blue, .fb-green, .fb-gold, .fb-white'
    );
    editables.forEach(node => {
      node.contentEditable = 'true';
    });

    const target = e.target.closest('[contenteditable="true"]');
    if (target) target.focus();
    else if (editables.length) editables[0].focus();
    e.stopPropagation();
  });

  el.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') exitEdit(el);
  });
}

document.querySelectorAll('.interactive').forEach(initializeInteractive);

document.addEventListener('mousemove', (e) => {
  document.querySelectorAll('.interactive').forEach(el => {
    const current = state.get(el);
    if (!current || !current.dragging) return;
    const dx = e.clientX - current.startX;
    const dy = e.clientY - current.startY;
    el.style.transform = `translate(${current.originX + dx}px, ${current.originY + dy}px)`;
  });
});

document.addEventListener('mouseup', () => {
  document.querySelectorAll('.interactive').forEach(el => {
    const current = state.get(el);
    if (!current || !current.dragging) return;
    current.dragging = false;
    el.classList.remove('dragging');
  });
});

document.addEventListener('mousedown', (e) => {
  const deleteBtn = e.target.closest('.delete-btn');
  if (deleteBtn) {
    e.preventDefault();
    e.stopPropagation();
    const host = deleteBtn.closest('.interactive');
    if (host) host.style.display = 'none';
    return;
  }

  document.querySelectorAll('.interactive').forEach(el => {
    if (!el.contains(e.target)) exitEdit(el);
  });
});

function resetAll() {
  document.querySelectorAll('.interactive').forEach(el => {
    const original = defaults[el.id];
    if (!original) return;

    el.style.display = original.display;
    el.style.transform = original.transform;
    el.innerHTML = original.html;
    el.classList.remove('editing', 'dragging');
    ensureDeleteButton(el);

    const current = state.get(el);
    if (current) {
      current.editing = false;
      current.dragging = false;
    }
  });
}
</script>



</body></html>